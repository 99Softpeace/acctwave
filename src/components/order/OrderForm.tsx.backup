import { useState, useMemo, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Calculator, Link as LinkIcon, ShoppingBag, CheckCircle, Rocket, ChevronRight, AlertCircle, TrendingUp, Hash, MessageCircle } from 'lucide-react';
import { FacebookLogo, InstagramLogo, TikTokLogo, YouTubeLogo, TwitterLogo, TelegramLogo, LinkedInLogo, SpotifyLogo } from '@/components/icons/SocialMediaLogos';

interface Service {
    service: number;
    name: string;
    type: string;
    category: string;
    rate: string;
    min: string;
    max: string;
    refill: boolean;
    cancel: boolean;
}

// Exchange rate: 1 USD = 1600 NGN
const USD_TO_NGN = 1600;

const getCategoryColor = (category: string) => {
    const lowerCategory = category.toLowerCase();

    if (lowerCategory.includes('instagram')) return 'from-pink-500 to-purple-500';
    if (lowerCategory.includes('facebook')) return 'from-blue-600 to-blue-400';
    if (lowerCategory.includes('twitter') || lowerCategory.includes('x ')) return 'from-sky-500 to-blue-400';
    if (lowerCategory.includes('youtube')) return 'from-red-600 to-red-400';
    if (lowerCategory.includes('tiktok')) return 'from-black to-pink-500';
    if (lowerCategory.includes('telegram')) return 'from-blue-500 to-cyan-400';
    if (lowerCategory.includes('linkedin')) return 'from-blue-700 to-blue-500';
    if (lowerCategory.includes('spotify')) return 'from-green-600 to-green-400';

    return 'from-primary to-blue-400'; // Default gradient
};

export default function OrderForm() {
    const [services, setServices] = useState<Service[]>([]);
    const [loadingServices, setLoadingServices] = useState(true);
    const [selectedCategory, setSelectedCategory] = useState("");
    const [selectedServiceId, setSelectedServiceId] = useState("");
    const [link, setLink] = useState("");
    const [quantity, setQuantity] = useState("");
    const [status, setStatus] = useState<'idle' | 'loading' | 'success' | 'error'>('idle');
    const [errorMessage, setErrorMessage] = useState("");
    const [orderId, setOrderId] = useState("");

    // Fetch Services on Mount
    useEffect(() => {
        async function fetchServices() {
            try {
                const res = await fetch('/api/services');
                if (!res.ok) throw new Error('Failed to fetch services');
                const data = await res.json();
                setServices(data);
            } catch (error) {
                console.error('Error loading services:', error);
                setErrorMessage('Failed to load services. Please try again later.');
            } finally {
                return services.filter(s => s.category === selectedCategory);
            }, [selectedCategory, services]);

    const selectedService = services.find(s => s.service.toString() === selectedServiceId.toString());
    const totalCostNGN = selectedService && quantity
        ? convertToNaira((parseFloat(selectedService.rate) * parseInt(quantity) / 1000))
        : "0.00";

    const handleCategorySelect = (category: string) => {
        setSelectedCategory(category);
        setSelectedServiceId(""); // Reset service when category changes
        setLink("");
        setQuantity("");
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!selectedService || !link || !quantity) return;

        setStatus('loading');
        setErrorMessage("");

        try {
            const res = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    serviceId: selectedService.service,
                    serviceName: selectedService.name,
                    link,
                    quantity: parseInt(quantity),
                    price: parseFloat(totalCostNGN)
                }),
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.message || 'Failed to place order');
            }

            setStatus('success');
            setOrderId(data.order.external_order_id);

            // Reset form after 3 seconds
            setTimeout(() => {
                setStatus('idle');
                setSelectedCategory("");
                setSelectedServiceId("");
                setLink("");
                setQuantity("");
                setOrderId("");
            }, 3000);

        } catch (error: any) {
            console.error('Order error:', error);
            setStatus('error');
            setErrorMessage(error.message || 'Something went wrong. Please try again.');
        }
    };

    if (loadingServices) {
        return (
            <div className="glass-card p-8 rounded-3xl border border-white/10 flex items-center justify-center min-h-[500px]">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
            </div>
        );
    }

    return (
        <div className="glass-card p-8 rounded-3xl border border-white/10 relative overflow-hidden min-h-[500px]">
            {/* Background Decor */}
            <div className="absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none" />

            <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                <ShoppingBag className="w-6 h-6 text-primary" />
                Place New Order
            </h2>

            <form onSubmit={handleSubmit} className="space-y-6 relative z-10">
                {/* Step 1: Category Selection - Grid Display */}
                <div className="space-y-3">
                    <label className="text-sm font-medium text-gray-300">Select Social Media Platform</label>

                    {!selectedCategory ? (
                        <motion.div
                            initial={{ opacity: 0 }}
                            animate={{ opacity: 1 }}
                            className="grid grid-cols-2 sm:grid-cols-3 gap-3"
                        >
                            {categories.map((category) => {
                                const Icon = getCategoryIcon(category);
                                const gradient = getCategoryColor(category);

                                return (
                                    <motion.button
                                        key={category}
                                        type="button"
                                        onClick={() => handleCategorySelect(category)}
                                        whileHover={{ scale: 1.02, y: -2 }}
                                        whileTap={{ scale: 0.98 }}
                                        className="group relative bg-[#080B1A] border border-white/10 rounded-xl p-4 hover:border-primary/50 transition-all overflow-hidden"
                                    >
                                        {/* Gradient overlay on hover */}
                                        <div className={`absolute inset-0 bg-gradient-to-br ${gradient} opacity-0 group-hover:opacity-10 transition-opacity`} />

                                        <div className="relative flex flex-col items-center gap-2 text-center">
                                            <div className={`w-12 h-12 rounded-full bg-gradient-to-br ${gradient} flex items-center justify-center`}>
                                                <Icon className="w-6 h-6 text-white" />
                                            </div>
                                            <span className="text-sm font-medium text-white group-hover:text-primary transition-colors line-clamp-2">
                                                {category}
                                            </span>
                                        </div>
                                    </motion.button>
                                );
                            })}
                        </motion.div>
                    ) : (
                        <motion.div
                            initial={{ opacity: 0, y: -10 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="flex items-center gap-3 bg-[#080B1A] border border-primary/30 rounded-xl p-4"
                        >
                            <div className={`w-10 h-10 rounded-full bg-gradient-to-br ${getCategoryColor(selectedCategory)} flex items-center justify-center shrink-0`}>
                                {(() => {
                                    const Icon = getCategoryIcon(selectedCategory);
                                    return <Icon className="w-5 h-5 text-white" />;
                                })()}
                            </div>
                            <div className="flex-1">
                                <p className="text-xs text-gray-400">Selected Platform</p>
                                <p className="text-white font-medium">{selectedCategory}</p>
                            </div>
                            <button
                                type="button"
                                onClick={() => handleCategorySelect("")}
                                className="text-xs text-primary hover:text-blue-400 transition-colors"
                            >
                                Change
                            </button>
                        </motion.div>
                    )}
                </div>

                <AnimatePresence>
                    {/* Step 2: Service Selection */}
                    {selectedCategory && (
                        <motion.div
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, y: -10 }}
                            className="space-y-6"
                        >
                            <div className="space-y-2">
                                <label className="text-sm font-medium text-gray-300">Service</label>
                                <select
                                    value={selectedServiceId}
                                    onChange={(e) => setSelectedServiceId(e.target.value)}
                                    className="w-full bg-[#080B1A] border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all appearance-none"
                                >
                                    <option value="" disabled>Choose a service...</option>
                                    {filteredServices.map(service => (
                                        <option key={service.service} value={service.service}>
                                            {service.name} - ₦{convertToNaira(service.rate)}/1k
                                        </option>
                                    ))}
                                </select>
                            </div>

                            {selectedService && (
                                <motion.div
                                    initial={{ opacity: 0, height: 0 }}
                                    animate={{ opacity: 1, height: 'auto' }}
                                    className="bg-primary/10 border border-primary/20 rounded-xl p-4 text-sm text-gray-300 space-y-1"
                                >
                                    <p><span className="text-primary font-bold">Min:</span> {selectedService.min}</p>
                                    <p><span className="text-primary font-bold">Max:</span> {selectedService.max}</p>
                                    <p><span className="text-primary font-bold">Rate:</span> ₦{convertToNaira(selectedService.rate)} per 1000</p>
                                </motion.div>
                            )}
                        </motion.div>
                    )}

                    {/* Step 3: Order Details */}
                    {selectedService && (
                        <motion.div
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, y: -10 }}
                            className="space-y-6"
                        >
                            {/* Link Input */}
                            <div className="space-y-2">
                                <label className="text-sm font-medium text-gray-300">Link</label>
                                <div className="relative">
                                    <LinkIcon className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" />
                                    <input
                                        type="url"
                                        value={link}
                                        onChange={(e) => setLink(e.target.value)}
                                        placeholder="https://instagram.com/username"
                                        className="w-full bg-[#080B1A] border border-white/10 rounded-xl pl-12 pr-4 py-3 text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                                        required
                                    />
                                </div>
                            </div>

                            {/* Quantity Input */}
                            <div className="space-y-2">
                                <label className="text-sm font-medium text-gray-300">Quantity</label>
                                <div className="relative">
                                    <Calculator className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" />
                                    <input
                                        type="number"
                                        value={quantity}
                                        onChange={(e) => setQuantity(e.target.value)}
                                        min={selectedService?.min}
                                        max={selectedService?.max}
                                        placeholder="1000"
                                        className="w-full bg-[#080B1A] border border-white/10 rounded-xl pl-12 pr-4 py-3 text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                                        required
                                    />
                                </div>
                            </div>

                            {/* Total Cost Display */}
                            <div className="bg-[#080B1A] rounded-xl p-4 flex justify-between items-center border border-white/5">
                                <span className="text-gray-400 font-medium">Total Cost</span>
                                <span className="text-2xl font-bold text-white glow-text">₦{totalCostNGN}</span>
                            </div>

                            {/* Error Message */}
                            {errorMessage && (
                                <div className="bg-red-500/10 border border-red-500/20 p-3 rounded-xl flex items-center gap-2 text-red-400 text-sm">
                                    <AlertCircle className="w-4 h-4 shrink-0" />
                                    {errorMessage}
                                </div>
                            )}

                            {/* Submit Button */}
                            <button
                                type="submit"
                                disabled={status === 'loading'}
                                className={`w-full py-4 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 ${status === 'loading'
                                    ? 'bg-gray-600 cursor-not-allowed'
                                    : status === 'success'
                                        ? 'bg-green-500 text-white'
                                        : 'bg-primary hover:bg-blue-600 text-white shadow-[0_0_20px_rgba(0,122,255,0.4)] hover:shadow-[0_0_30px_rgba(0,122,255,0.6)]'
                                    }`}
                            >
                                {status === 'loading' ? (
                                    <span className="animate-pulse">Processing...</span>
                                ) : status === 'success' ? (
                                    <>
                                        <CheckCircle className="w-5 h-5" /> Order Placed!
                                    </>
                                ) : (
                                    'Submit Order'
                                )}
                            </button>

                            {status === 'success' && (
                                <motion.div
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    className="text-center text-green-400 text-sm font-medium"
                                >
                                    Order ID: #{orderId}
                                </motion.div>
                            )}
                        </motion.div>
                    )}
                </AnimatePresence>
            </form>
        </div>
    );
}
